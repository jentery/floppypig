var game={data:{score:0,steps:0,start:!1,newHiScore:!1,muted:!1},onload:function(){return me.video.init("screen",me.video.CANVAS,900,600,!0,"auto")?(me.audio.init("mp3,ogg"),me.loader.onload=this.loaded.bind(this),me.loader.preload(game.resources),me.state.change(me.state.LOADING),void("#debug"===document.location.hash&&window.onReady(function(){me.plugin.register.defer(this,me.debug.Panel,"debug",me.input.KEY.V)}))):void alert("Your browser does not support HTML5 canvas.")},loaded:function(){me.state.set(me.state.MENU,new game.TitleScreen),me.state.set(me.state.PLAY,new game.PlayScreen),me.state.set(me.state.GAME_OVER,new game.GameOverScreen),me.input.bindKey(me.input.KEY.SPACE,"fly",!0),me.input.bindKey(me.input.KEY.M,"mute",!0),me.input.bindPointer(me.input.KEY.SPACE),me.input.bindKey(me.input.KEY.G,"invert_gravity",!0),me.pool.register("clumsy",BirdEntity),me.pool.register("pipe",PipeEntity,!0),me.pool.register("hit",HitEntity,!0),me.pool.register("ground",Ground,!0),me.game.viewport.setBounds(0,0,900,600),me.state.change(me.state.MENU)},onLevelLoaded:function(){}};game.resources=[{name:"bg",type:"image",src:"data/img/bg.png"},{name:"clumsy",type:"image",src:"data/img/clumsy.png"},{name:"cat",type:"image",src:"data/img/cat.png"},{name:"pipe1",type:"image",src:"data/img/pipe1.png"},{name:"logo",type:"image",src:"data/img/logo.png"},{name:"ground",type:"image",src:"data/img/ground.png"},{name:"gameover",type:"image",src:"data/img/gameover.png"},{name:"gameoverbg",type:"image",src:"data/img/gameoverbg.png"},{name:"hit",type:"image",src:"data/img/hit.png"},{name:"getready",type:"image",src:"data/img/getready.png"},{name:"new",type:"image",src:"data/img/new.png"},{name:"share",type:"image",src:"data/img/share.png"},{name:"tweet",type:"image",src:"data/img/tweet.png"},{name:"rainbow",type:"image",src:"data/img/rainbow.png"},{name:"theme",type:"audio",src:"data/bgm/"},{name:"theme_nyan",type:"audio",src:"data/bgm/"},{name:"hit",type:"audio",src:"data/sfx/"},{name:"lose",type:"audio",src:"data/sfx/"},{name:"wing",type:"audio",src:"data/sfx/"}];var BirdEntity=me.Entity.extend({init:function(a,b){var c={};c.image=me.loader.getImage("cat"),c.width=85,c.height=60,c.spritewidth=68,c.spriteheight=42,this._super(me.Entity,"init",[a,b,c]),this.alwaysUpdate=!0,this.body.gravity=.2,this.gravityForce=.01,this.gravityInverted=0,this.gravityInvertFlag=0,this.maxAngleRotationUp=-Math.PI/6,this.maxAngleRotationDown=Math.PI/6,this.maxAngleRotationUpExtreme=-Math.PI/2,this.maxAngleRotationDownExtreme=Math.PI/2,this.gravityAngleGradient=Number.prototype.degToRad(.5),this.renderable.addAnimation("flying",[0,1,2,3,4,5,6,7,8,9,10,11]),this.renderable.addAnimation("idle",[0]),this.renderable.setCurrentAnimation("flying"),this.renderable.anchorPoint=new me.Vector2d(.1,.5),this.body.addShape(new me.Rect(5,5,68,42)),this.flyTween=new me.Tween(this.pos),this.flyTween.easing(me.Tween.Easing.Exponential.InOut),this.endTween=null,this.collided=!1,this.name="clumsy",this.lol_count=0;var d=this;this.flyTween.onUpdate(function(){0===d.gravityInverted?d.renderable.angle+30:-d.renderable.angle-30})},update:function(a){if(!game.data.start)return this._super(me.Entity,"update",[a]);if(0===this.gravityInverted)if(me.input.isKeyPressed("fly")){me.audio.play("wing"),this.gravityForce=.02;var b=this.pos.y;this.flyTween.stop(),this.flyTween.to({y:b-62},100),this.flyTween.start(),this.renderable.angle=this.maxAngleRotationUp}else this.gravityForce+=.2,this.pos.y+=me.timer.tick*this.gravityForce,this.renderable.angle+=this.gravityAngleGradient*this.gravityForce,this.renderable.angle>this.maxAngleRotationDownExtreme&&(this.renderable.angle=this.maxAngleRotationDownExtreme);else if(me.input.isKeyPressed("fly")){me.audio.play("wing"),this.gravityForce=-.02;var b=this.pos.y;this.flyTween.stop(),this.flyTween.to({y:b+62},100),this.flyTween.start(),this.renderable.angle=-this.maxAngleRotationDown}else this.gravityForce-=.2,this.pos.y+=me.timer.tick*this.gravityForce,this.renderable.angle-=this.gravityAngleGradient*this.gravityForce,this.renderable.angle>this.maxAngleRotationDownExtreme&&(this.renderable.angle=this.maxAngleRotationDownExtreme);me.game.world.addChild(new RainbowEntity(this.pos.x-10,this.pos.y,0===this.gravityInverted?this.renderable.angle:-this.renderable.angle));var c=-100;return this.pos.y<=c||this.collided?(game.data.start=!1,me.audio.play("lose"),this.endAnimation(),!1):(me.collision.check(this),this.updateBounds(),this._super(me.Entity,"update",[a]),!0)},onCollision:function(a){var b=a.b;("pipe"===b.type||"ground"===b.type)&&(me.device.vibrate(500),this.collided=!0),"hit"===b.type&&(me.game.world.removeChildNow(b),game.data.steps++,me.audio.play("hit"),this.pos.x=60,b.gravityInverter===!0&&(this.flyTween.stop(),0===this.gravityInverted?(this.gravityInverted=1,this.gravityForce=-.005,this.renderable.angle=0):(this.gravityInverted=0,this.gravityForce=.005,this.renderable.angle=0),this.renderable.flipY(1===this.gravityInverted),this.pos.y=0===this.gravityInverted?b.pos.y:b.pos.y-18,console.log("o "+b.pos.y+" b "+this.pos.y),this.updateBounds()))},endAnimation:function(){me.game.viewport.fadeOut("#fff",100);var a=this.renderable.pos.y;this.endTween=new me.Tween(this.renderable.pos),this.endTween.easing(me.Tween.Easing.Exponential.InOut),this.flyTween.stop(),this.renderable.angle=this.maxAngleRotationDown;var b=me.video.renderer.getHeight()-this.renderable.width/2-96;this.endTween.to({y:a},1e3).to({y:b},1e3).onComplete(function(){me.state.change(me.state.GAME_OVER)}),this.endTween.start()},externallyInvertGravity:function(){}}),PipeEntity=me.Entity.extend({init:function(a,b){var c={};c.image=this.image=me.loader.getImage("pipe1"),c.width=148,c.height=1664,c.spritewidth=148,c.spriteheight=1664,this._super(me.Entity,"init",[a,b,c]),this.alwaysUpdate=!0,this.body.addShape(new me.Rect(0,0,c.width,c.height)),this.body.gravity=0,this.body.vel.set(-5,0),this.type="pipe"},update:function(a){return game.data.start?(this.pos.add(this.body.vel),this.pos.x<-this.image.width&&me.game.world.removeChild(this),this.updateBounds(),this._super(me.Entity,"update",[a]),!0):this._super(me.Entity,"update",[a])}}),PipeGenerator=me.Renderable.extend({init:function(){this._super(me.Renderable,"init",[0,me.game.viewport.width,me.game.viewport.height]),this.alwaysUpdate=!0,this.generate=0,this.pipeFrequency=92,this.pipeHoleSize=1240,this.gravityInvertCounter=1,this.gravityInvertFrequency=Number.prototype.random(1,15),this.posX=me.game.viewport.width},update:function(a){if(this.generate++===this.pipeFrequency){this.generate=0;var b,c=Number.prototype.random(me.video.renderer.getHeight()-100,200),d=c-me.video.renderer.getHeight()-this.pipeHoleSize,e=Number.prototype.random(0,3),f=new me.pool.pull("pipe",this.posX,c,e),g=new me.pool.pull("pipe",this.posX,d,e),h=c-100;this.gravityInvertCounter++===this.gravityInvertFrequency?(this.gravityInvertCounter=1,this.gravityInvertFrequency=Number.prototype.random(1,15),b=new me.pool.pull("hit",this.posX,h,!0)):b=new me.pool.pull("hit",this.posX,h,!1),f.renderable.flipY(!0),me.game.world.addChild(f,10),me.game.world.addChild(g,10),me.game.world.addChild(b,11)}return this._super(me.Entity,"update",[a]),!0}}),HitEntity=me.Entity.extend({init:function(a,b,c){var d={};d.image=this.image=me.loader.getImage("hit"),d.width=148,d.height=60,d.spritewidth=148,d.spriteheight=60,this._super(me.Entity,"init",[a,b,d]),this.alwaysUpdate=!0,this.body.gravity=0,this.updateTime=!1,this.renderable.alpha=0,this.body.accel.set(-5,0),this.body.addShape(new me.Rect(0,0,d.width-30,d.height-30)),this.type="hit",this.gravityInverter=c},update:function(a){return this.pos.add(this.body.accel),this.pos.x<-this.image.width&&me.game.world.removeChild(this),this.updateBounds(),this._super(me.Entity,"update",[a]),!0}}),Ground=me.Entity.extend({init:function(a,b){var c={};c.width=900,c.height=1,this._super(me.Entity,"init",[a,b,c]),this.alwaysUpdate=!0,this.body.gravity=0,this.body.vel.set(-4,0),this.body.addShape(new me.Rect(0,0,c.width,c.height)),this.type="ground"},update:function(a){return this._super(me.Entity,"update",[a])}}),RainbowEntity=me.Entity.extend({init:function(a,b,c){var d={};d.image=me.loader.getImage("rainbow"),d.width=20,d.height=36,this._super(me.Entity,"init",[a,b,d]),this.alwaysUpdate=!0,this.body.gravity=0,this.body.vel.set(-6,0),this.body.addShape(new me.Rect(0,0,d.width,d.height)),this.renderable.angle=c,this.body.collisionType=me.collision.types.NO_OBJECT,this.type="rainbow"},update:function(a){return this.pos.add(this.body.vel),this.pos.x<-this.renderable.width&&me.game.world.removeChild(this),this.updateBounds(),this._super(me.Entity,"update",[a])}});game.HUD=game.HUD||{},game.HUD.Container=me.Container.extend({init:function(){this._super(me.Container,"init"),this.isPersistent=!0,this.collidable=!1,this.z=1/0,this.name="HUD",this.addChild(new game.HUD.ScoreItem(5,5))}}),game.HUD.ScoreItem=me.Renderable.extend({init:function(a,b){this._super(me.Renderable,"init",[a,b,10,10]),this.stepsFont=new me.Font("gamefont",80,"#000","center"),this.floating=!0},draw:function(a){var b=a.getContext();game.data.start&&me.state.isCurrent(me.state.PLAY)&&this.stepsFont.draw(b,game.data.steps,me.video.renderer.getWidth()/2,10)}});var BackgroundLayer=me.ImageLayer.extend({init:function(a,b){name=a,width=900,height=600,ratio=1,this._super(me.ImageLayer,"init",[name,width,height,a,b,ratio])},update:function(){return me.input.isKeyPressed("mute")&&(game.data.muted=!game.data.muted,game.data.muted?me.audio.disable():me.audio.enable()),!0}}),Share=me.GUI_Object.extend({init:function(a,b){var c={};c.image="share",c.spritewidth=150,c.spriteheight=75,this._super(me.GUI_Object,"init",[a,b,c])},onClick:function(){var a="Just made "+game.data.steps+" steps on Clumsy Bird! Can you beat me? Try online here!",b="http://ellisonleao.github.io/clumsy-bird/";return FB.ui({method:"feed",name:"My Clumsy Bird Score!",caption:"Share to your friends",description:a,link:b,picture:"http://ellisonleao.github.io/clumsy-bird/data/img/clumsy.png"}),!1}}),Tweet=me.GUI_Object.extend({init:function(a,b){var c={};c.image="tweet",c.spritewidth=152,c.spriteheight=75,this._super(me.GUI_Object,"init",[a,b,c])},onClick:function(){var a="Just made "+game.data.steps+" steps on Clumsy Bird! Can you beat me? Try online here!",b="http://ellisonleao.github.io/clumsy-bird/",c="clumsybird,melonjs";return window.open("https://twitter.com/intent/tweet?text="+a+"&hashtags="+c+"&count="+b+"&url="+b,"Tweet!","height=300,width=400"),!1}});game.TitleScreen=me.ScreenObject.extend({init:function(){this._super(me.ScreenObject,"init"),this.font=null,this.ground1=null,this.ground2=null,this.logo=null},onResetEvent:function(){me.audio.stop("theme_nyan"),game.data.newHiScore=!1,me.game.world.addChild(new BackgroundLayer("bg",1)),me.input.bindKey(me.input.KEY.ENTER,"enter",!0),me.input.bindKey(me.input.KEY.SPACE,"enter",!0),me.input.bindPointer(me.input.mouse.LEFT,me.input.KEY.ENTER),this.handler=me.event.subscribe(me.event.KEYDOWN,function(a){"enter"===a&&me.state.change(me.state.PLAY)});var a=me.loader.getImage("logo");this.logo=new me.Sprite(me.game.viewport.width/2-170,-a,a),me.game.world.addChild(this.logo,10);me.pool.pull("me.Tween",this.logo.pos).to({y:me.game.viewport.height/2-100},1e3).easing(me.Tween.Easing.Exponential.InOut).start();me.game.world.addChild(new(me.Renderable.extend({init:function(){this._super(me.Renderable,"init",[0,0,100,100]),this.text=me.device.touch?"Tap to start":'PRESS SPACE OR CLICK LEFT MOUSE BUTTON TO START \n														PRESS "M" TO MUTE SOUND \n\n								WARNING : The gravity can flip any time !',this.font=new me.Font("gamefont",20,"#000")},draw:function(a){var b=a.getContext(),c=this.font.measureText(b,this.text),d=me.game.viewport.width/2-c.width/2,e=me.game.viewport.height/2+50;this.font.draw(b,this.text,d,e)}})),12)},onDestroyEvent:function(){me.event.unsubscribe(this.handler),me.input.unbindKey(me.input.KEY.ENTER),me.input.unbindKey(me.input.KEY.SPACE),me.input.unbindPointer(me.input.mouse.LEFT),this.ground1=null,this.ground2=null,me.game.world.removeChild(this.logo),this.logo=null}}),game.PlayScreen=me.ScreenObject.extend({init:function(){me.audio.play("theme_nyan",!0);var a=me.device.ua.contains("Firefox")?.3:.5;me.audio.setVolume(a),this._super(me.ScreenObject,"init")},onResetEvent:function(){me.game.reset(),me.audio.stop("theme_nyan"),game.data.muted||me.audio.play("theme_nyan",!0),me.input.bindKey(me.input.KEY.SPACE,"fly",!0),game.data.score=0,game.data.steps=0,game.data.start=!1,game.data.newHiscore=!1,me.game.world.addChild(new BackgroundLayer("bg",1)),this.ground1=me.pool.pull("ground",0,me.video.renderer.getHeight()-96),this.ground2=me.pool.pull("ground",me.video.renderer.getWidth(),me.video.renderer.getHeight()-96),me.game.world.addChild(this.ground1,11),me.game.world.addChild(this.ground2,11),this.HUD=new game.HUD.Container,me.game.world.addChild(this.HUD),this.bird=me.pool.pull("clumsy",60,me.game.viewport.height/2-100),me.game.world.addChild(this.bird,10),me.input.bindPointer(me.input.mouse.LEFT,me.input.KEY.SPACE),this.getReady=new me.Sprite(me.video.renderer.getWidth()/2-200,me.video.renderer.getHeight()/2-100,me.loader.getImage("getready")),me.game.world.addChild(this.getReady,11);{var a=this;new me.Tween(this.getReady).to({alpha:0},2e3).easing(me.Tween.Easing.Linear.None).onComplete(function(){game.data.start=!0,me.game.world.addChild(new PipeGenerator,0),me.game.world.removeChild(a.getReady)}).start()}},onDestroyEvent:function(){me.audio.stopTrack("theme_nyan"),this.HUD=null,this.bird=null,this.ground1=null,this.ground2=null,me.input.unbindKey(me.input.KEY.SPACE),me.input.unbindPointer(me.input.mouse.LEFT)}}),game.GameOverScreen=me.ScreenObject.extend({init:function(){this.savedData=null,this.handler=null},onResetEvent:function(){this.savedData={score:game.data.score,steps:game.data.steps},me.save.add(this.savedData),me.save.topSteps||me.save.add({topSteps:game.data.steps}),game.data.steps>me.save.topSteps&&(me.save.topSteps=game.data.steps,game.data.newHiScore=!0),me.input.bindKey(me.input.KEY.ENTER,"enter",!0),me.input.bindKey(me.input.KEY.SPACE,"enter",!1),me.input.bindPointer(me.input.mouse.LEFT,me.input.KEY.ENTER),this.handler=me.event.subscribe(me.event.KEYDOWN,function(a){"enter"===a&&me.state.change(me.state.MENU)});var a=me.loader.getImage("gameover");me.game.world.addChild(new me.Sprite(me.video.renderer.getWidth()/2-a.width/2,me.video.renderer.getHeight()/2-a.height/2-100,a),12);var b=me.loader.getImage("gameoverbg");if(me.game.world.addChild(new me.Sprite(me.video.renderer.getWidth()/2-b.width/2,me.video.renderer.getHeight()/2-b.height/2,b),10),me.game.world.addChild(new BackgroundLayer("bg",1)),game.data.newHiScore){var c=new me.Sprite(235,355,me.loader.getImage("new"));me.game.world.addChild(c,12)}this.dialog=new(me.Renderable.extend({init:function(){this._super(me.Renderable,"init",[0,0,100,100]),this.font=new me.Font("gamefont",40,"black","left"),this.steps="Score: "+game.data.steps.toString(),this.topSteps="High Score: "+me.save.topSteps.toString()},draw:function(a){{var b=a.getContext(),c=this.font.measureText(b,this.steps);this.font.measureText(b,this.topSteps),this.font.measureText(b,this.score)}this.font.draw(b,this.steps,me.game.viewport.width/2-c.width/2-60,me.game.viewport.height/2),this.font.draw(b,this.topSteps,me.game.viewport.width/2-c.width/2-60,me.game.viewport.height/2+50)}})),me.game.world.addChild(this.dialog,12)},onDestroyEvent:function(){me.event.unsubscribe(this.handler),me.input.unbindKey(me.input.KEY.ENTER),me.input.unbindKey(me.input.KEY.SPACE),me.input.unbindPointer(me.input.mouse.LEFT),this.ground1=null,this.ground2=null,this.font=null,me.audio.stop("theme_nyan")}});